{% extends "multifactor/base.html" %}
{% load static %}

{% block card_title %}Multifactor Authentication{% endblock %}
{% block card_classes %}{% endblock %}

{% block content %}
<div class="btn-group mb-4 ml-4 float-right">
	<button class="btn btn-success dropdown-toggle" data-toggle="dropdown">
		Add Method&nbsp;<span class="caret"></span>
	</button>
	<div class="dropdown-menu dropdown-menu-right">
		{% for link, label in available_methods %}
		<a class="dropdown-item" href="{% url link %}">{{label}}</a>
		{% endfor %}
	</div>
</div>

<p>To keep your account secure, you can add one or more secondary authentication factors. These are commonly USB keys, or codes acquired through a secure mechanism like an authenticator. </p>

<table class="table table-striped mb-0">
	<thead>
		<tr>
			<th>Type</th>
			<th>Added</th>
			<th></th>
		</tr>
	</thead>
	<tbody>
		{% for key in keys %}
		<tr>
			<td class="align-middle">
				<strong>{{ key.get_key_type_display }}</strong>
				{% if key.device %}<br><small>{{ key.device }}</small>{% endif %}
			</td>
			<td class="align-middle">
				Added: {{ key.added_on }}<br>
				Expires: {{ key.expires|default:"Never" }}<br>
				Last used: {{ key.last_used|default:"Never" }}
			</td>
			<td class="align-middle" style="width:10%;white-space: nowrap;">
				<input type="checkbox" value="{{key.id}}" {{key.enabled|yesno:'checked,'}} data-onstyle="success" data-offstyle="danger" data-toggle="toggle" class="status_chk">
				<button class="btn btn-danger delete" data-key="{{key.id}}">Delete</button>
			</td>
		</tr>
		{% empty %}
		<tr>
			<td colspan="3" align="center">You don't have any keys yet, please add one.</td>
		</tr>
		{% endfor %}
	</tbody>
</table>
{% endblock %}


{% block head %}
<link href="{% static 'multifactor/css/bootstrap-toggle.min.css' %}" rel="stylesheet">
<script src="{% static 'multifactor/js/bootstrap-toggle.min.js' %}"></script>
<style>.toggle-handle {background:#ddd}</style>

<script type="text/javascript">
	function confirmDel(id) {
	}

	$("body").on('change', '.status_chk', function(ev) {
		$.ajax({
			url: "{% url 'multifactor:toggle_key' %}?id=" + $(this).val(),
			success: function (data) {
				console.log(data)
				if (data == "Error")
					$(this).toggle()
			},
			error: function (data) {
				$(this).toggle()
			}
		})

	}).on('click', '.delete', function(ev) {
		if (!confirm('Are you sure you want to delete this key?'))
			return;

		$.ajax({
			url: "{% url 'multifactor:del_key' %}",
			data: {"id": $(this).data('key')},
			success: function (data) {
				window.location.reload();
			}
		})
	});
</script>
{% endblock %}