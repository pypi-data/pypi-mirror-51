import unittest
from os import urandom


from ethsnarks.jubjub import Point, FQ
from ethsnarks.eddsa import EdDSA, PureEdDSA, MiMCEdDSA


class TestEdDSA(unittest.TestCase):
	def test_signverify(self):
		B = Point.from_hash(b'eddsa_base')
		k, A = EdDSA.random_keypair()
		m = urandom(32)

		# Hash-EdDSA
		smsg = EdDSA.sign(m, k, B)
		self.assertTrue(EdDSA.verify(*smsg, B))

		# Pure-EdDSA (no message pre-hash)
		smsg = PureEdDSA.sign(m, k, B)
		self.assertTrue(PureEdDSA.verify(*smsg, B))

	def test_mimc_eddsa(self):
		A = Point(FQ(1301009284721359989986872336829887838687570550075011148323334415657243668534),
				  FQ(6027072831423449649615427623935115177649426117898838224822914942466592945166))
		R = Point(FQ(16697780772074863636681870538986108875460311579901354831891912949591301444465),
				  FQ(4226867824412371436973606126220323912943722787513450804471487686191426145939))
		s = 740212824778436527565151771778503009743408793780835234261147965780852431216
		m = [1, 2, 3]
		self.assertTrue(MiMCEdDSA.verify(A, (R,s), m))

	def test_hash_eddsa(self):
		# Used to verify compatibility with test_jubjub_eddsa.cpp
		A = Point(FQ(333671881179914989291633188949569309119725676183802886621140166987382124337),
				  FQ(4050436616325076046600891135828313078248584449767955905006778857958871314574))
		R = Point(FQ(21473010389772475573783051334263374448039981396476357164143587141689900886674),
				  FQ(11330590229113935667895133446882512506792533479705847316689101265088791098646))
		s = 21807294168737929637405719327036335125520717961882955117047593281820367379946
		m = b'abc'
		self.assertTrue(EdDSA.verify(A, (R, s), m))
		self.assertFalse(PureEdDSA.verify(A, (R, s), m))

	def test_pure_eddsa(self):
		# Used to verify compatibility with test_jubjub_eddsa.cpp
		A = Point(FQ(333671881179914989291633188949569309119725676183802886621140166987382124337),
				  FQ(4050436616325076046600891135828313078248584449767955905006778857958871314574))
		R = Point(FQ(17815983127755465894346158776246779862712623073638768513395595796132990361464),
				  FQ(947174453624106321442736396890323086851143728754269151257776508699019857364))
		s = 13341814865473145800030207090487687417599620847405735706082771659861699337012
		m = b'abcd'
		self.assertTrue(PureEdDSA.verify(A, (R, s), m))
		self.assertFalse(EdDSA.verify(A, (R, s), m))


if __name__ == "__main__":
	unittest.main()
