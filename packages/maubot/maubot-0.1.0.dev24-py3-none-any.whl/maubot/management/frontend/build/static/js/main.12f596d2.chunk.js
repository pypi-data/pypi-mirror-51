(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{115:function(e,t,a){e.exports=a(239)},120:function(e,t,a){},239:function(e,t,a){"use strict";a.r(t);var n=a(0),s=a.n(n),r=a(29),i=a.n(r),l=(a(120),a(8)),o=a(31),c=a(15);var h=e=>{let t=e.component,a=e.render,n=e.authed,r=e.to,i=void 0===r?"/login":r,l=Object(c.a)(e,["component","render","authed","to"]);return s.a.createElement(o.b,Object.assign({},l,{render:e=>!0===n?t?s.a.createElement(t,e):a():s.a.createElement(o.a,{to:{pathname:i}})}))};var d=e=>s.a.createElement("div",Object.assign({},e,{className:"spinner ".concat(e.className||"")}),s.a.createElement("svg",{viewBox:"25 25 50 50"},s.a.createElement("circle",{cx:"50",cy:"50",r:"20",fill:"none",strokeWidth:"2",strokeMiterlimit:"10"})));const p="/_matrix/maubot/v1";function m(e="application/json"){return{"Content-Type":e,Authorization:"Bearer ".concat(localStorage.accessToken)}}async function u(e,t){const a=await fetch("".concat(p,"/").concat(e,"/").concat(t),{headers:m(),method:"DELETE"});return 204===a.status?{success:!0}:await a.json()}async function g(e,t,a,n){const s=await fetch("".concat(p,"/").concat(e,"/").concat(a||t.id).concat(n||""),{headers:m(),body:JSON.stringify(t),method:"PUT"});return await s.json()}async function v(e){const t=await fetch("".concat(p).concat(e),{headers:m()});return await t.json()}let E=null;const y=async()=>{E=await v("/features")};let b=void 0;var f={BASE_PATH:p,login:async function(e,t){const a=await fetch("".concat(p,"/auth/login"),{method:"POST",body:JSON.stringify({username:e,password:t})});return await a.json()},ping:async function(){const e=await fetch("".concat(p,"/auth/ping"),{method:"POST",headers:m()}),t=await e.json();if(t.username)return E=t.features,t.username;if("auth_token_missing"===t.errcode||"auth_token_invalid"===t.errcode)return E||await y(),null;throw t},getFeatures:()=>E,remoteGetFeatures:y,openLogSocket:async function(){let e="https:"===window.location.protocol?"wss:":"ws:";const t="".concat(e,"//").concat(window.location.host).concat(p,"/logs"),a={socket:null,connected:!1,authenticated:!1,onLog:e=>void 0,onHistory:e=>void 0,fails:-1},n=()=>{a.socket.send(localStorage.accessToken),a.connected=!0},s=e=>{const t=JSON.parse(e.data);void 0!==t.auth_success?t.auth_success?(console.info("Websocket connection authentication successful"),a.authenticated=!0,a.fails=-1):console.info("Websocket connection authentication failed"):t.history?a.onHistory(t.history):a.onLog(t)},r=e=>{e&&(4e3===e.code?console.error("Websocket connection failed: access token invalid or not provided"):1012===e.code&&console.info("Websocket connection closed: server is restarting")),a.connected=!1,a.socket=null,a.fails++,setTimeout(()=>{a.socket=new WebSocket(t),a.socket.onopen=n,a.socket.onmessage=s,a.socket.onclose=r},Math.min(5*a.fails*1e3,3e4))};return r(),a},debugOpenFile:async function(e,t){const a=await fetch("".concat(p,"/debug/open"),{headers:m(),body:JSON.stringify({path:e,line:t}),method:"POST"});return await a.json()},debugOpenFileEnabled:()=>b,updateDebugOpenFileEnabled:async()=>{const e=await v("/debug/open");b=e.enabled||!1},getInstances:()=>v("/instances"),getInstance:e=>v("/instance/".concat(e)),putInstance:(e,t)=>g("instance",e,t),deleteInstance:e=>u("instance",e),getInstanceDatabase:e=>v("/instance/".concat(e,"/database")),queryInstanceDatabase:async(e,t)=>{const a=await fetch("".concat(p,"/instance/").concat(e,"/database/query"),{headers:m(),body:JSON.stringify({query:t}),method:"POST"});return await a.json()},getPlugins:()=>v("/plugins"),getPlugin:e=>v("/plugin/".concat(e)),uploadPlugin:async function(e,t){let a;return a=t?await fetch("".concat(p,"/plugin/").concat(t),{headers:m("application/zip"),body:e,method:"PUT"}):await fetch("".concat(p,"/plugins/upload"),{headers:m("application/zip"),body:e,method:"POST"}),await a.json()},deletePlugin:e=>u("plugin",e),getClients:()=>v("/clients"),getClient:e=>v("/clients/".concat(e)),uploadAvatar:async function(e,t,a){const n=await fetch("".concat(p,"/proxy/").concat(e,"/_matrix/media/r0/upload"),{headers:m(a),body:t,method:"POST"});return await n.json()},getAvatarURL:function({id:e,avatar_url:t}){return(t=t||"").startsWith("mxc://")&&(t=t.substr("mxc://".length)),"".concat(p,"/proxy/").concat(e,"/_matrix/media/r0/download/").concat(t,"?access_token=").concat(localStorage.accessToken)},putClient:e=>g("client",e),deleteClient:e=>u("client",e),clearClientCache:async function(e){const t=await fetch("".concat(p,"/client/").concat(e,"/clearcache"),{headers:m(),method:"POST"});return await t.json()},getClientAuthServers:()=>v("/client/auth/servers"),doClientAuth:async function(e,t,a,n){const s=await fetch("".concat(p,"/client/auth/").concat(e,"/").concat(t),{headers:m(),body:JSON.stringify({username:a,password:n}),method:"POST"});return await s.json()}},w=a(26);function N(){return(N=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}var C=s.a.createElement("path",{fill:"#000000",d:"M17,13H13V17H11V13H7V11H11V7H13V11H17M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"});const S=({svgRef:e,...t})=>s.a.createElement("svg",N({width:24,height:24,viewBox:"0 0 24 24",ref:e},t),C),O=s.a.forwardRef((e,t)=>s.a.createElement(S,N({svgRef:t},e)));a.p;var k=a(111),x=a.n(k);a(131),a(132);function L(){return(L=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}var j=s.a.createElement("path",{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),R=s.a.createElement("path",{d:"M0 0h24v24H0z",fill:"none"});const T=({svgRef:e,...t})=>s.a.createElement("svg",L({width:24,height:24,viewBox:"0 0 24 24",ref:e},t),j,R),F=s.a.forwardRef((e,t)=>s.a.createElement(T,L({svgRef:t},e)));a.p;var P=a(113),I=a(112);var _=class extends n.Component{constructor(e){super(e),this.toggle=(()=>{this.props.onToggle?this.props.onToggle(!this.state.active):this.setState({active:!this.state.active})}),this.toggleKeyboard=(e=>(" "===e.key||"Enter"===e.key)&&this.toggle()),this.state={active:e.active}}componentWillReceiveProps(e){this.setState({active:e.active})}render(){return s.a.createElement("div",{className:"switch","data-active":this.state.active,onClick:this.toggle,tabIndex:"0",onKeyPress:this.toggleKeyboard,id:this.props.id},s.a.createElement("div",{className:"box"},s.a.createElement("span",{className:"text"},s.a.createElement("span",{className:"on"},this.props.onText||"On"),s.a.createElement("span",{className:"off"},this.props.offText||"Off"))))}};const D=({children:e,wrapperClass:t})=>t?s.a.createElement("div",{className:t},s.a.createElement("div",{className:"preference-table"},e)):s.a.createElement("div",{className:"preference-table"},e),M=({name:e,fullWidth:t=!1,labelFor:a,changed:n=!1,children:r})=>s.a.createElement("div",{className:"entry ".concat(t?"full-width":""," ").concat(n?"changed":"")},s.a.createElement("label",{htmlFor:a},e),s.a.createElement("div",{className:"value"},r)),A=e=>{let t=e.rowName,a=e.value,n=e.origValue,r=e.fullWidth,i=void 0!==r&&r,l=Object(c.a)(e,["rowName","value","origValue","fullWidth"]);return s.a.createElement(M,{name:t,fullWidth:i,labelFor:t,changed:void 0!==n&&a!==n},s.a.createElement("input",Object.assign({},l,{value:a,id:t})))},B=e=>{let t=e.rowName,a=e.active,n=e.origActive,r=e.fullWidth,i=void 0!==r&&r,l=Object(c.a)(e,["rowName","active","origActive","fullWidth"]);return s.a.createElement(M,{name:t,fullWidth:i,labelFor:t,changed:void 0!==n&&a!==n},s.a.createElement(_,Object.assign({},l,{active:a,id:t})))},V=e=>{let t=e.rowName,a=e.value,n=e.origValue,r=e.fullWidth,i=void 0!==r&&r,l=e.creatable,o=void 0!==l&&l,h=Object(c.a)(e,["rowName","value","origValue","fullWidth","creatable"]);return s.a.createElement(M,{name:t,fullWidth:i,labelFor:t,changed:void 0!==n&&a.id!==n},o?s.a.createElement(I.a,Object.assign({className:"select"},h,{id:t,value:a})):s.a.createElement(P.a,Object.assign({className:"select"},h,{id:t,value:a})))};var W=D;var H=class extends n.Component{constructor(e){super(e),this.delete=(async()=>{if(!window.confirm("Are you sure you want to delete ".concat(this.state.id,"?")))return;this.setState({deleting:!0});const e=await this.deleteFunc(this.state.id);e.success?(this.props.history.push("/"),this.props.onDelete()):this.setState({deleting:!1,error:e.error})}),this.inputChange=(e=>{e.target.name&&this.setState({[e.target.name]:e.target.value})}),this.renderInstances=(()=>!this.isNew&&s.a.createElement("div",{className:"instances"},s.a.createElement("h3",null,this.hasInstances?"Instances":"No instances :("),this.state.instances.map(e=>s.a.createElement(l.b,{className:"instance",key:e.id,to:"/instance/".concat(e.id)},e.id)))),this.renderLogButton=(e=>!this.isNew&&f.getFeatures().log&&s.a.createElement("div",{className:"buttons"},s.a.createElement("button",{className:"open-log",onClick:()=>this.props.openLog(e)},"View logs"))),this.state=Object.assign(this.initialState,e.entry)}componentWillReceiveProps(e){const t=Object.assign(this.initialState,e.entry);for(const a of this.entryKeys)this.props.entry[a]===e.entry[a]&&(t[a]=this.state[a]);this.setState(t)}get entryKeys(){return[]}get initialState(){return{}}get hasInstances(){return this.state.instances&&this.state.instances.length>0}get isNew(){return!this.props.entry.id}async readFile(e){return new Promise((t,a)=>{const n=new FileReader;n.readAsArrayBuffer(e),n.onload=(e=>t(e.target.result)),n.onerror=(e=>a(e))})}},U=a(49);function q(){return(q=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}var z=s.a.createElement("path",{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"}),Q=s.a.createElement("path",{d:"M0 0h24v24H0z",fill:"none"});const K=({svgRef:e,...t})=>s.a.createElement("svg",q({width:24,height:24,viewBox:"0 0 24 24",ref:e},t),z,Q),J=s.a.forwardRef((e,t)=>s.a.createElement(K,q({svgRef:t},e)));a.p;function G(){return(G=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}var Y=s.a.createElement("path",{d:"M7 10l5 5 5-5z"}),Z=s.a.createElement("path",{d:"M0 0h24v24H0z",fill:"none"});const $=({svgRef:e,...t})=>s.a.createElement("svg",G({width:24,height:24,viewBox:"0 0 24 24",ref:e},t),Y,Z),X=s.a.forwardRef((e,t)=>s.a.createElement($,G({svgRef:t},e)));a.p;function ee(){return(ee=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}var te=s.a.createElement("path",{d:"M7 14l5-5 5 5z"}),ae=s.a.createElement("path",{d:"M0 0h24v24H0z",fill:"none"});const ne=({svgRef:e,...t})=>s.a.createElement("svg",ee({width:24,height:24,viewBox:"0 0 24 24",ref:e},t),te,ae),se=s.a.forwardRef((e,t)=>s.a.createElement(ne,ee({svgRef:t},e)));a.p;Map.prototype.map=function(e){const t=[];for(const n of this){var a=Object(w.a)(n,2);const s=a[0],r=a[1];t.push(e(r,s,this))}return t};var re=Object(o.g)(class extends n.Component{constructor(e){super(e),this.reloadContent=(async(e=!0)=>{this.setState({loading:!0});const t=await f.queryInstanceDatabase(this.props.instanceID,this.state.query);this.setState({loading:!1}),e&&this.setState({prevQuery:null,rowCount:null,insertedPrimaryKey:null,error:null}),t.ok?t.rows?this.setState({header:t.columns,content:t.rows}):(this.setState({prevQuery:t.query,rowCount:t.rowcount,insertedPrimaryKey:t.insertedPrimaryKey}),this.buildSQLQuery(this.state.selectedTable,!1)):this.setState({error:t.error})}),this.deleteRow=(async(e,t)=>{const a=this.state.content[t.row],n=this.state.header,s=[];for(const o of Object.entries(n)){var r=Object(w.a)(o,2);const e=r[0],t=r[1],n=a[e];s.push("".concat(t,"='").concat(this.sqlEscape(n.toString()),"'"))}const i="DELETE FROM ".concat(this.state.selectedTable," WHERE ").concat(s.join(" AND ")),l=await f.queryInstanceDatabase(this.props.instanceID,i);this.setState({prevQuery:"DELETE FROM ".concat(this.state.selectedTable," ..."),rowCount:l.rowcount}),await this.reloadContent(!1)}),this.editCell=(async(e,t)=>{console.log("Edit",t)}),this.collectContextMeta=(e=>({row:e.row,col:e.col})),this.sqlEscape=(e=>e.replace(/[\0\x08\x09\x1a\n\r"'\\%]/g,e=>{switch(e){case"\0":return"\\0";case"\b":return"\\b";case"\t":return"\\t";case"\x1a":return"\\z";case"\n":return"\\n";case"\r":return"\\r";case'"':case"'":case"\\":case"%":return"\\"+e;default:return e}})),this.renderTable=(()=>s.a.createElement("div",{className:"table"},this.state.header?s.a.createElement(s.a.Fragment,null,s.a.createElement("table",null,s.a.createElement("thead",null,s.a.createElement("tr",null,this.state.header.map(e=>s.a.createElement("td",{key:e},s.a.createElement("span",{onClick:()=>this.toggleSort(e),title:this.getColumnType(e)},s.a.createElement("strong",null,e),this.getColumnInfo(e),this.getSortIcon(e)))))),s.a.createElement("tbody",null,this.state.content.map((e,t)=>s.a.createElement("tr",{key:t},e.map((e,a)=>s.a.createElement(U.b,{key:a,id:"database_table_menu",renderTag:"td",row:t,col:a,collect:this.collectContextMeta},e)))))),s.a.createElement(U.a,{id:"database_table_menu"},s.a.createElement(U.c,{onClick:this.deleteRow},"Delete row"),s.a.createElement(U.c,{disabled:!0,onClick:this.editCell},"Edit cell"))):this.state.loading?s.a.createElement(d,null):null)),this.state={tables:null,header:null,content:null,query:"",selectedTable:null,error:null,prevQuery:null,rowCount:null,insertedPrimaryKey:null},this.order=new Map}async componentWillMount(){const e=new Map(Object.entries(await f.getInstanceDatabase(this.props.instanceID)));for(const n of e){var t=Object(w.a)(n,2);const e=t[0],s=t[1];s.name=e,s.columns=new Map(Object.entries(s.columns));for(const t of s.columns){var a=Object(w.a)(t,2);const e=a[0],n=a[1];n.name=e,n.sort=null}}this.setState({tables:e}),this.checkLocationTable()}componentDidUpdate(e){this.props.location!==e.location&&(this.order=new Map,this.setState({header:null,content:null}),this.checkLocationTable())}checkLocationTable(){const e="/instance/".concat(this.props.instanceID,"/database/");if(this.props.location.pathname.startsWith(e)){const t=this.props.location.pathname.substr(e.length);this.setState({selectedTable:t}),this.buildSQLQuery(t)}}getSortQueryParams(e){const t=[];for(const n of Array.from(this.order.entries()).reverse()){var a=Object(w.a)(n,2);const e=a[0],s=a[1];t.push("order=".concat(e,":").concat(s))}return t}buildSQLQuery(e=this.state.selectedTable,t=!0){let a="SELECT * FROM ".concat(e);if(this.order.size>0){const e=Array.from(this.order.entries()).reverse().map(([e,t])=>"".concat(e," ").concat(t));a+=" ORDER BY ".concat(e.join(", "))}a+=" LIMIT 100",this.setState({query:a},()=>this.reloadContent(t))}toggleSort(e){const t=this.order.get(e)||"auto";switch(this.order.delete(e),t){case"auto":this.order.set(e,"DESC");break;case"DESC":this.order.set(e,"ASC")}this.buildSQLQuery()}getSortIcon(e){switch(this.order.get(e)){case"DESC":return s.a.createElement(X,null);case"ASC":return s.a.createElement(se,null);default:return null}}getColumnInfo(e){const t=this.state.tables.get(this.state.selectedTable);if(!t)return null;const a=t.columns.get(e);return a?a.primary?s.a.createElement("span",{className:"meta"},"\xa0(pk)"):a.unique?s.a.createElement("span",{className:"meta"},"\xa0(u)"):null:null}getColumnType(e){const t=this.state.tables.get(this.state.selectedTable);if(!t)return null;const a=t.columns.get(e);return a?a.type:null}renderContent(){return s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"tables"},this.state.tables.map((e,t)=>s.a.createElement(l.c,{key:t,to:"/instance/".concat(this.props.instanceID,"/database/").concat(t)},t))),s.a.createElement("div",{className:"query"},s.a.createElement("input",{type:"text",value:this.state.query,name:"query",onChange:e=>this.setState({query:e.target.value})}),s.a.createElement("button",{type:"submit",onClick:this.reloadContent},"Query")),this.state.error&&s.a.createElement("div",{className:"error"},this.state.error),this.state.prevQuery&&s.a.createElement("div",{className:"prev-query"},s.a.createElement("p",null,"Executed ",s.a.createElement("span",{className:"query"},this.state.prevQuery)," - affected ",s.a.createElement("strong",null,this.state.rowCount," rows"),"."),this.state.insertedPrimaryKey&&s.a.createElement("p",{className:"inserted-primary-key"},"Inserted primary key: ",this.state.insertedPrimaryKey)),this.renderTable())}render(){return s.a.createElement("div",{className:"instance-database"},s.a.createElement("div",{className:"topbar"},s.a.createElement(l.b,{className:"topbar",to:"/instance/".concat(this.props.instanceID)},s.a.createElement(J,null),"Back")),this.state.tables?this.renderContent():s.a.createElement(d,{className:"maubot-loading"}))}});class ie extends H{constructor(e){super(e),this.clientSelectEntry=(e=>e&&{id:e.id,value:e.id,label:s.a.createElement("div",{className:"select-client"},s.a.createElement("img",{className:"avatar",src:f.getAvatarURL(e),alt:""}),s.a.createElement("span",{className:"displayname"},e.displayname||e.id))}),this.save=(async()=>{this.setState({saving:!0});const e=await f.putInstance(this.instanceInState,this.props.entry?this.props.entry.id:void 0);e.id?(this.isNew?this.props.history.push("/instance/".concat(e.id)):(e.id!==this.props.entry.id&&this.props.history.replace("/instance/".concat(e.id)),this.setState({saving:!1,error:""})),this.props.onChange(e)):this.setState({saving:!1,error:e.error})}),this.renderDatabase=(()=>s.a.createElement(re,{instanceID:this.props.entry.id})),this.renderMain=(()=>s.a.createElement("div",{className:"instance"},s.a.createElement(W,null,s.a.createElement(A,{rowName:"ID",type:"text",name:"id",value:this.state.id,placeholder:"fancybotinstance",onChange:this.inputChange,disabled:!this.isNew,fullWidth:!0,className:"id"}),s.a.createElement(B,{rowName:"Enabled",active:this.state.enabled,origActive:this.props.entry.enabled,onToggle:e=>this.setState({enabled:e})}),s.a.createElement(B,{rowName:"Running",active:this.state.started,origActive:this.props.entry.started,onToggle:e=>this.setState({started:e})}),f.getFeatures().client?s.a.createElement(V,{rowName:"Primary user",options:this.clientOptions,isSearchable:!1,value:this.selectedClientEntry,origValue:this.props.entry.primary_user,onChange:({id:e})=>this.setState({primary_user:e})}):s.a.createElement(A,{rowName:"Primary user",type:"text",name:"primary_user",value:this.state.primary_user,placeholder:"@user:example.com",onChange:this.inputChange}),f.getFeatures().plugin?s.a.createElement(V,{rowName:"Type",options:this.typeOptions,isSearchable:!1,value:this.selectedPluginEntry,origValue:this.props.entry.type,onChange:({id:e})=>this.setState({type:e})}):s.a.createElement(A,{rowName:"Type",type:"text",name:"type",value:this.state.type,placeholder:"xyz.maubot.example",onChange:this.inputChange})),!this.isNew&&s.a.createElement(x.a,{mode:"yaml",theme:"github",onChange:e=>this.setState({config:e}),name:"config",value:this.state.config,editorProps:{fontSize:"10pt",$blockScrolling:!0}}),s.a.createElement("div",{className:"buttons"},!this.isNew&&s.a.createElement("button",{className:"delete",onClick:this.delete,disabled:this.loading},this.state.deleting?s.a.createElement(d,null):"Delete"),s.a.createElement("button",{className:"save ".concat(this.isValid?"":"disabled-bg"),onClick:this.save,disabled:this.loading||!this.isValid},this.state.saving?s.a.createElement(d,null):this.isNew?"Create":"Save")),!this.isNew&&s.a.createElement("div",{className:"buttons"},this.props.entry.database&&s.a.createElement(l.b,{className:"button open-database",to:"/instance/".concat(this.state.id,"/database")},"View database"),f.getFeatures().log&&s.a.createElement("button",{className:"open-log",onClick:()=>this.props.openLog("instance.".concat(this.state.id))},"View logs")),s.a.createElement("div",{className:"error"},this.state.error))),this.deleteFunc=f.deleteInstance,this.updateClientOptions()}get entryKeys(){return["id","primary_user","enabled","started","type","config"]}get initialState(){return{id:"",primary_user:"",enabled:!0,started:!0,type:"",config:"",saving:!1,deleting:!1,error:""}}get instanceInState(){const e=Object.assign({},this.state);return delete e.saving,delete e.deleting,delete e.error,e}componentWillReceiveProps(e){super.componentWillReceiveProps(e),this.updateClientOptions()}updateClientOptions(){this.clientOptions=Object.values(this.props.ctx.clients).map(this.clientSelectEntry)}get selectedClientEntry(){return this.state.primary_user?this.clientSelectEntry(this.props.ctx.clients[this.state.primary_user]):{}}get selectedPluginEntry(){return{id:this.state.type,value:this.state.type,label:this.state.type}}get typeOptions(){return Object.values(this.props.ctx.plugins).map(e=>e&&{id:e.id,value:e.id,label:e.id})}get loading(){return this.state.deleting||this.state.saving}get isValid(){return this.state.id&&this.state.primary_user&&this.state.type}render(){return s.a.createElement(o.d,null,s.a.createElement(o.b,{path:"/instance/:id/database",render:this.renderDatabase}),s.a.createElement(o.b,{render:this.renderMain}))}}ie.ListEntry=(({entry:e})=>s.a.createElement(l.c,{className:"instance entry",to:"/instance/".concat(e.id)},s.a.createElement("span",{className:"id"},e.id),s.a.createElement(F,null)));var le=Object(o.g)(ie);function oe(){return(oe=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}var ce=s.a.createElement("path",{fill:"#000000",d:"M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"});const he=({svgRef:e,...t})=>s.a.createElement("svg",oe({width:24,height:24,viewBox:"0 0 24 24",ref:e},t),ce),de=s.a.forwardRef((e,t)=>s.a.createElement(he,oe({svgRef:t},e)));a.p;class pe extends H{constructor(e){super(e),this.homeserverEntry=(([e,t])=>t&&{id:t,value:t,label:e||t}),this.avatarUpload=(async e=>{const t=e.target.files[0];this.setState({uploadingAvatar:!0});const a=await this.readFile(t),n=await f.uploadAvatar(this.state.id,a,t.type);this.setState({uploadingAvatar:!1,avatar_url:n.content_uri})}),this.save=(async()=>{this.setState({saving:!0});const e=await f.putClient(this.clientInState);e.id?(this.isNew?this.props.history.push("/client/".concat(e.id)):this.setState({saving:!1,error:""}),this.props.onChange(e)):this.setState({saving:!1,error:e.error})}),this.startOrStop=(async()=>{this.setState({startingOrStopping:!0});const e=await f.putClient({id:this.props.entry.id,started:!this.props.entry.started});e.id?(this.props.onChange(e),this.setState({startingOrStopping:!1,error:""})):this.setState({startingOrStopping:!1,error:e.error})}),this.clearCache=(async()=>{this.setState({clearingCache:!0});const e=await f.clearClientCache(this.props.entry.id);e.success?this.setState({clearingCache:!1,error:""}):this.setState({clearingCache:!1,error:e.error})}),this.renderStartedContainer=(()=>{let e;return e=this.props.entry.started?this.props.entry.sync_ok?"Started":"Erroring":this.props.entry.enabled?"Stopped":"Disabled",s.a.createElement("div",{className:"started-container"},s.a.createElement("span",{className:"started ".concat(this.props.entry.started,"\n                             ").concat(this.props.entry.sync_ok?"sync_ok":"sync_error","\n                             ").concat(this.props.entry.enabled?"":"disabled")}),s.a.createElement("span",{className:"text"},e))}),this.renderSidebar=(()=>!this.isNew&&s.a.createElement("div",{className:"sidebar"},s.a.createElement("div",{className:"avatar-container ".concat(this.state.avatar_url?"":"no-avatar","\n                        ").concat(this.state.uploadingAvatar?"uploading":"")},s.a.createElement("img",{className:"avatar",src:f.getAvatarURL(this.state),alt:"Avatar"}),s.a.createElement(de,{className:"upload"}),s.a.createElement("input",{className:"file-selector",type:"file",accept:"image/png, image/jpeg",onChange:this.avatarUpload,disabled:this.state.uploadingAvatar,onDragEnter:e=>e.target.parentElement.classList.add("drag"),onDragLeave:e=>e.target.parentElement.classList.remove("drag")}),this.state.uploadingAvatar&&s.a.createElement(d,null)),this.renderStartedContainer(),(this.props.entry.started||this.props.entry.enabled)&&s.a.createElement(s.a.Fragment,null,s.a.createElement("button",{className:"save",onClick:this.startOrStop,disabled:this.loading},this.state.startingOrStopping?s.a.createElement(d,null):this.props.entry.started?"Stop":"Start"),s.a.createElement("button",{className:"clearcache",onClick:this.clearCache,disabled:this.loading},this.state.clearingCache?s.a.createElement(d,null):"Clear cache")))),this.renderPreferences=(()=>s.a.createElement(D,null,s.a.createElement(A,{rowName:"User ID",type:"text",disabled:!this.isNew,fullWidth:!0,name:this.isNew?"id":"",className:"id",value:this.state.id,origValue:this.props.entry.id,placeholder:"@fancybot:example.com",onChange:this.inputChange}),f.getFeatures().client_auth?s.a.createElement(V,{rowName:"Homeserver",options:this.homeserverOptions,isSearchable:!0,value:this.selectedHomeserver,origValue:this.props.entry.homeserver,onChange:({value:e})=>this.setState({homeserver:e}),creatable:!0,isValidNewOption:this.isValidHomeserver}):s.a.createElement(A,{rowName:"Homeserver",type:"text",name:"homeserver",value:this.state.homeserver,origValue:this.props.entry.homeserver,placeholder:"https://example.com",onChange:this.inputChange}),s.a.createElement(A,{rowName:"Access token",type:"text",name:"access_token",value:this.state.access_token,origValue:this.props.entry.access_token,placeholder:"MDAxYWxvY2F0aW9uIG1hdHJpeC5sb2NhbAowMDEzaWRlbnRpZmllc",onChange:this.inputChange}),s.a.createElement(A,{rowName:"Display name",type:"text",name:"displayname",value:this.state.displayname,origValue:this.props.entry.displayname,placeholder:"My fancy bot",onChange:this.inputChange}),s.a.createElement(A,{rowName:"Avatar URL",type:"text",name:"avatar_url",value:this.state.avatar_url,origValue:this.props.entry.avatar_url,placeholder:"mxc://example.com/mbmwyoTvPhEQPiCskcUsppko",onChange:this.inputChange}),s.a.createElement(B,{rowName:"Sync",active:this.state.sync,origActive:this.props.entry.sync,onToggle:e=>this.setState({sync:e})}),s.a.createElement(B,{rowName:"Autojoin",active:this.state.autojoin,origActive:this.props.entry.autojoin,onToggle:e=>this.setState({autojoin:e})}),s.a.createElement(B,{rowName:"Enabled",active:this.state.enabled,origActive:this.props.entry.enabled,onToggle:e=>this.setState({enabled:e,started:e&&this.state.started})}))),this.renderPrefButtons=(()=>s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"buttons"},!this.isNew&&s.a.createElement("button",{className:"delete ".concat(this.hasInstances?"disabled-bg":""),onClick:this.delete,disabled:this.loading||this.hasInstances,title:this.hasInstances?"Can't delete client that is in use":""},this.state.deleting?s.a.createElement(d,null):"Delete"),s.a.createElement("button",{className:"save",onClick:this.save,disabled:this.loading},this.state.saving?s.a.createElement(d,null):this.isNew?"Create":"Save")),this.renderLogButton(this.state.id),s.a.createElement("div",{className:"error"},this.state.error))),this.deleteFunc=f.deleteClient,this.homeserverOptions={}}get entryKeys(){return["id","displayname","homeserver","avatar_url","access_token","sync","autojoin","enabled","started"]}get initialState(){return{id:"",displayname:"",homeserver:"",avatar_url:"",access_token:"",sync:!0,autojoin:!0,enabled:!0,started:!1,instances:[],uploadingAvatar:!1,saving:!1,deleting:!1,startingOrStopping:!1,clearingCache:!1,error:""}}get clientInState(){const e=Object.assign({},this.state);return delete e.uploadingAvatar,delete e.saving,delete e.deleting,delete e.startingOrStopping,delete e.clearingCache,delete e.error,delete e.instances,e}get selectedHomeserver(){return this.state.homeserver?this.homeserverEntry([this.props.ctx.homeserversByURL[this.state.homeserver],this.state.homeserver]):{}}componentWillReceiveProps(e){super.componentWillReceiveProps(e),this.updateHomeserverOptions()}updateHomeserverOptions(){this.homeserverOptions=Object.entries(this.props.ctx.homeserversByName).map(this.homeserverEntry)}isValidHomeserver(e){try{return Boolean(new URL(e))}catch(t){return!1}}get loading(){return this.state.saving||this.state.startingOrStopping||this.clearingCache||this.state.deleting}render(){return s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"client"},this.renderSidebar(),s.a.createElement("div",{className:"info"},this.renderPreferences(),this.renderPrefButtons(),this.renderInstances())))}}pe.ListEntry=(({entry:e})=>{const t=["client","entry"];return e.enabled?e.started||t.push("stopped"):t.push("disabled"),s.a.createElement(l.c,{className:t.join(" "),to:"/client/".concat(e.id)},s.a.createElement("img",{className:"avatar",src:f.getAvatarURL(e),alt:""}),s.a.createElement("span",{className:"displayname"},e.displayname||e.id),s.a.createElement(F,null))});var me=Object(o.g)(pe);class ue extends H{constructor(e){super(e),this.upload=(async e=>{const t=e.target.files[0];this.setState({uploadingAvatar:!0});const a=await this.readFile(t),n=await f.uploadPlugin(a,this.state.id);n.id?(this.isNew?this.props.history.push("/plugin/".concat(n.id)):this.setState({saving:!1,error:""}),this.props.onChange(n)):this.setState({saving:!1,error:n.error})}),this.deleteFunc=f.deletePlugin}get initialState(){return{id:"",version:"",instances:[],uploading:!1,deleting:!1,error:""}}render(){return s.a.createElement("div",{className:"plugin"},!this.isNew&&s.a.createElement(W,null,s.a.createElement(A,{rowName:"ID",type:"text",value:this.state.id,disabled:!0,className:"id"}),s.a.createElement(A,{rowName:"Version",type:"text",value:this.state.version,disabled:!0})),f.getFeatures().plugin_upload&&s.a.createElement("div",{className:"upload-box ".concat(this.state.uploading?"uploading":"")},s.a.createElement(de,{className:"upload"}),s.a.createElement("input",{className:"file-selector",type:"file",accept:"application/zip+mbp",onChange:this.upload,disabled:this.state.uploading||this.state.deleting,onDragEnter:e=>e.target.parentElement.classList.add("drag"),onDragLeave:e=>e.target.parentElement.classList.remove("drag")}),this.state.uploading&&s.a.createElement(d,null)),!this.isNew&&s.a.createElement("div",{className:"buttons"},s.a.createElement("button",{className:"delete ".concat(this.hasInstances?"disabled-bg":""),onClick:this.delete,disabled:this.loading||this.hasInstances,title:this.hasInstances?"Can't delete plugin that is in use":""},this.state.deleting?s.a.createElement(d,null):"Delete")),this.renderLogButton("loader.zip"),s.a.createElement("div",{className:"error"},this.state.error),this.renderInstances())}}ue.ListEntry=(({entry:e})=>s.a.createElement(l.c,{className:"plugin entry",to:"/plugin/".concat(e.id)},s.a.createElement("span",{className:"id"},e.id),s.a.createElement(F,null)));var ge=Object(o.g)(ue);var ve=class extends n.Component{render(){return s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"home"},"See sidebar to get started"),s.a.createElement("div",{className:"buttons"}))}},Ee=a(114),ye=a.n(Ee);const be=16;class fe extends n.Component{constructor(e){super(e),this.open=(()=>this.setState({open:!0})),this.close=(()=>this.setState({open:!1})),this.isOpen=(()=>this.state.open),this.state={open:!1},this.wrapper={clientWidth:9001}}render(){return this.state.open&&s.a.createElement("div",{className:"modal-wrapper-wrapper",ref:e=>this.wrapper=e,onClick:()=>this.wrapper.clientWidth>45*be&&this.close()},s.a.createElement("div",{className:"modal-wrapper",onClick:e=>e.stopPropagation()},s.a.createElement("button",{className:"close",onClick:this.close},"Close"),s.a.createElement("div",{className:"modal"},s.a.createElement(fe.Context.Provider,{value:this},this.props.children))))}}fe.Context=Object(n.createContext)(null);var we=fe;class Ne extends n.PureComponent{renderName(){const e=this.props.line;if(e.nameLink){const t=this.context;return s.a.createElement(l.b,{to:e.nameLink,onClick:t.close},e.name)}return e.name}renderContent(){if(this.props.line.matrix_http_request){const e=this.props.line.matrix_http_request;return s.a.createElement(s.a.Fragment,null,e.method," ",e.path,s.a.createElement("div",{className:"content"},Object.entries(e.content).length>0&&s.a.createElement(ye.a,{data:{content:e.content},hideRoot:!0})))}return this.props.line.msg}onClickOpen(e,t){return()=>(f.debugOpenFileEnabled()&&f.debugOpenFile(e,t),!1)}renderTimeTitle(){return this.props.line.time.toDateString()}renderTime(){return s.a.createElement("a",{className:"time",title:this.renderTimeTitle(),href:"file:///".concat(this.props.line.pathname,":").concat(this.props.line.lineno),onClick:this.onClickOpen(this.props.line.pathname,this.props.line.lineno)},this.props.line.time.toLocaleTimeString("en-GB"))}renderLevelName(){return s.a.createElement("span",{className:"level"},this.props.line.levelname)}get unfocused(){return this.props.focus&&this.props.line.name!==this.props.focus?"unfocused":""}renderRow(e){return s.a.createElement("div",{className:"row ".concat(this.props.line.levelname.toLowerCase()," ").concat(this.unfocused)},this.renderTime(),this.renderLevelName(),s.a.createElement("span",{className:"logger"},this.renderName()),s.a.createElement("span",{className:"text"},e))}renderExceptionInfo(){if(!f.debugOpenFileEnabled())return this.props.line.exc_info;const e=[];let t=this.props.line.exc_info.replace(/File "(.+)", line ([0-9]+), in (.+)/g,(t,a,n,r)=>(e.push(s.a.createElement("a",{href:"file:///".concat(a,":").concat(n),onClick:this.onClickOpen(a,n)},'File "',a,'", line ',n,", in ",r)),"||EDGE||"));e.reverse();const a=[];let n=0;for(const r of t.split("||EDGE||"))a.push(s.a.createElement(s.a.Fragment,{key:n++},r,e.pop()));return a}render(){return s.a.createElement(s.a.Fragment,null,this.renderRow(this.renderContent()),this.props.line.exc_info&&this.renderRow(this.renderExceptionInfo()))}}Ne.contextType=we.Context;class Ce extends n.PureComponent{constructor(e){super(e),this.linesRef=s.a.createRef(),this.linesBottomRef=s.a.createRef()}getSnapshotBeforeUpdate(){return!(!this.linesRef.current||!this.linesBottomRef.current)&&Ce.isVisible(this.linesRef.current,this.linesBottomRef.current)}componentDidUpdate(e,t,a){a&&Ce.scrollParentToChild(this.linesRef.current,this.linesBottomRef.current)}componentDidMount(){this.linesRef.current&&this.linesBottomRef.current&&Ce.scrollParentToChild(this.linesRef.current,this.linesBottomRef.current)}static scrollParentToChild(e,t){const a=e.getBoundingClientRect(),n=t.getBoundingClientRect();Ce.isVisible(e,t)||e.scrollBy({top:n.top+e.scrollTop-a.top})}static isVisible(e,t){const a=e.getBoundingClientRect(),n=t.getBoundingClientRect();return n.top>=a.top&&n.top<=a.top+e.clientHeight}render(){return s.a.createElement("div",{className:"log",ref:this.linesRef},s.a.createElement("div",{className:"lines"},this.props.lines.map(e=>s.a.createElement(Ne,{key:e.id,line:e,focus:this.props.focus}))),s.a.createElement("div",{ref:this.linesBottomRef}))}}var Se=Ce;var Oe=Object(o.g)(class extends n.Component{constructor(e){super(e),this.openLog=(e=>{this.setState({logFocus:"string"===typeof e?e:null}),this.logModal.open()}),this.renderNotFound=((e="path")=>s.a.createElement("div",{className:"not-found"},"Oops! I'm afraid that ",e," couldn't be found.")),this.renderDisabled=((e="path")=>s.a.createElement("div",{className:"not-found"},"The ",e," API has been disabled in the maubot config.")),this.state={instances:{},clients:{},plugins:{},homeserversByName:{},homeserversByURL:{},sidebarOpen:!1,modalOpen:!1,logFocus:null,logLines:[]},this.logModal={open:()=>void 0,isOpen:()=>!1},window.maubot=this}componentDidUpdate(e){this.props.location!==e.location&&this.setState({sidebarOpen:!1})}async componentWillMount(){const e=await Promise.all([f.getInstances(),f.getClients(),f.getPlugins(),f.getClientAuthServers(),f.updateDebugOpenFileEnabled()]),t=Object(w.a)(e,4),a=t[0],n=t[1],s=t[2],r=t[3],i={};if(f.getFeatures().instance)for(const p of a)i[p.id]=p;const l={};if(f.getFeatures().client)for(const p of n)l[p.id]=p;const o={};if(f.getFeatures().plugin)for(const p of s)o[p.id]=p;const c=r,h={};if(f.getFeatures().client_auth)for(const p of Object.entries(r)){var d=Object(w.a)(p,2);const e=d[0];h[d[1]]=e}this.setState({instances:i,clients:l,plugins:o,homeserversByName:c,homeserversByURL:h}),await this.enableLogs()}async enableLogs(){if(!f.getFeatures().log)return;const e=await f.openLogSocket(),t=e=>{e.time=new Date(e.time),e.name.startsWith("maubot.")&&(e.name=e.name.substr("maubot.".length)),e.name.startsWith("client.")?(e.name=e.name.substr("client.".length),e.nameLink="/client/".concat(e.name)):e.name.startsWith("instance.")&&(e.nameLink="/instance/".concat(e.name.substr("instance.".length)))};e.onHistory=(e=>{for(const a of e)t(a);this.setState({logLines:e})}),e.onLog=(e=>{t(e),this.setState({logLines:this.state.logLines.concat(e)})})}renderList(e,t){return this.state[e]&&Object.values(this.state[e]).map(e=>s.a.createElement(t,{key:e.id,entry:e}))}delete(e,t){const a=Object.assign({},this.state[e]);delete a[t],this.setState({[e]:a})}add(e,t,a){const n=Object.assign({},this.state[e]);a&&a!==t.id&&delete n[a],n[t.id]=t,this.setState({[e]:n})}renderView(e,t,a){const n=e.slice(0,-1);if(!f.getFeatures()[n])return this.renderDisabled(n);const r=this.state[e][a];return r?s.a.createElement(t,{entry:r,onDelete:()=>this.delete(e,a),onChange:t=>this.add(e,t,a),openLog:this.openLog,ctx:this.state}):this.renderNotFound(n)}renderMain(){return s.a.createElement("div",{className:"dashboard ".concat(this.state.sidebarOpen?"sidebar-open":"")},s.a.createElement(l.b,{to:"/",className:"title"},s.a.createElement("img",{src:"favicon.png",alt:""}),"Maubot Manager"),s.a.createElement("div",{className:"user"},s.a.createElement("span",null,localStorage.username)),s.a.createElement("nav",{className:"sidebar"},s.a.createElement("div",{className:"buttons"},f.getFeatures().log&&s.a.createElement("button",{className:"open-log",onClick:this.openLog},s.a.createElement("span",null,"View logs"))),f.getFeatures().instance&&s.a.createElement("div",{className:"instances list"},s.a.createElement("div",{className:"title"},s.a.createElement("h2",null,"Instances"),s.a.createElement(l.b,{to:"/new/instance"},s.a.createElement(O,null))),this.renderList("instances",le.ListEntry)),f.getFeatures().client&&s.a.createElement("div",{className:"clients list"},s.a.createElement("div",{className:"title"},s.a.createElement("h2",null,"Clients"),s.a.createElement(l.b,{to:"/new/client"},s.a.createElement(O,null))),this.renderList("clients",me.ListEntry)),f.getFeatures().plugin&&s.a.createElement("div",{className:"plugins list"},s.a.createElement("div",{className:"title"},s.a.createElement("h2",null,"Plugins"),f.getFeatures().plugin_upload&&s.a.createElement(l.b,{to:"/new/plugin"},s.a.createElement(O,null))),this.renderList("plugins",ge.ListEntry))),s.a.createElement("div",{className:"topbar",onClick:e=>this.setState({sidebarOpen:!this.state.sidebarOpen})},s.a.createElement("div",{className:"hamburger ".concat(this.state.sidebarOpen?"active":"")},s.a.createElement("span",null),s.a.createElement("span",null),s.a.createElement("span",null))),s.a.createElement("main",{className:"view"},s.a.createElement(o.d,null,s.a.createElement(o.b,{path:"/",exact:!0,render:()=>s.a.createElement(ve,{openLog:this.openLog})}),s.a.createElement(o.b,{path:"/new/instance",render:()=>s.a.createElement(le,{onChange:e=>this.add("instances",e),entry:{},ctx:this.state})}),s.a.createElement(o.b,{path:"/new/client",render:()=>s.a.createElement(me,{onChange:e=>this.add("clients",e),entry:{},ctx:this.state})}),s.a.createElement(o.b,{path:"/new/plugin",render:()=>s.a.createElement(ge,{onChange:e=>this.add("plugins",e),entry:{},ctx:this.state})}),s.a.createElement(o.b,{path:"/instance/:id",render:({match:e})=>this.renderView("instances",le,e.params.id)}),s.a.createElement(o.b,{path:"/client/:id",render:({match:e})=>this.renderView("clients",me,e.params.id)}),s.a.createElement(o.b,{path:"/plugin/:id",render:({match:e})=>this.renderView("plugins",ge,e.params.id)}),s.a.createElement(o.b,{render:()=>this.renderNotFound()}))))}renderModal(){return s.a.createElement(we,{ref:e=>this.logModal=e},s.a.createElement(Se,{lines:this.state.logLines,focus:this.state.logFocus}))}render(){return s.a.createElement(s.a.Fragment,null,this.renderMain(),this.renderModal())}});var ke=class extends n.Component{constructor(e,t){super(e,t),this.inputChanged=(e=>this.setState({[e.target.name]:e.target.value})),this.login=(async()=>{this.setState({loading:!0});const e=await f.login(this.state.username,this.state.password);e.token?await this.props.onLogin(e.token):e.error?this.setState({error:e.error,loading:!1}):(this.setState({error:"Unknown error",loading:!1}),console.log("Unknown error:",e))}),this.state={username:"",password:"",loading:!1,error:""}}render(){return f.getFeatures().login?s.a.createElement("div",{className:"login-wrapper"},s.a.createElement("div",{className:"login ".concat(this.state.error&&"errored")},s.a.createElement("h1",null,"Maubot Manager"),s.a.createElement("input",{type:"text",placeholder:"Username",value:this.state.username,name:"username",onChange:this.inputChanged}),s.a.createElement("input",{type:"password",placeholder:"Password",value:this.state.password,name:"password",onChange:this.inputChanged}),s.a.createElement("button",{onClick:this.login},this.state.loading?s.a.createElement(d,null):"Log in"),this.state.error&&s.a.createElement("div",{className:"error"},this.state.error))):s.a.createElement("div",{className:"login-wrapper"},s.a.createElement("div",{className:"login errored"},s.a.createElement("h1",null,"Maubot Manager"),s.a.createElement("div",{className:"error"},"Login has been disabled in the maubot config.")))}};var xe=class extends n.Component{constructor(e){super(e),this.login=(async e=>{localStorage.accessToken=e,await this.ping()}),this.state={pinged:!1,authed:!1}}async componentWillMount(){localStorage.accessToken?await this.ping():await f.remoteGetFeatures(),this.setState({pinged:!0})}async ping(){try{const t=await f.ping();t?(localStorage.username=t,this.setState({authed:!0})):delete localStorage.accessToken}catch(e){console.error(e)}}render(){return this.state.pinged?s.a.createElement(l.a,null,s.a.createElement("div",{className:"maubot-wrapper ".concat(this.state.authed?"authenticated":"")},s.a.createElement(o.d,null,s.a.createElement(h,{path:"/login",render:()=>s.a.createElement(ke,{onLogin:this.login}),authed:!this.state.authed,to:"/"}),s.a.createElement(h,{path:"/",component:Oe,authed:this.state.authed})))):s.a.createElement(d,{className:"maubot-loading"})}};i.a.render(s.a.createElement(xe,null),document.getElementById("root"))}},[[115,1,2]]]);
//# sourceMappingURL=main.12f596d2.chunk.js.map