{% extends 'bee_django_course/base.html' %}

{% block content %}
    <video width='320' height='240' controls id="videos_1">
        <source src="http://dv.manxuetang.com/1555125586110334.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <video width='320' height='240' controls id="video_2">
        <source src="http://dv.manxuetang.com/%E6%B5%8B%E8%AF%95.mov" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div>
        <h3>七牛上传测试</h3>

        <div id="fsUploadProgress">
            <div id="control-container">
                <input type="file" id="choose_file"/>
                <button class="btn btn-default control-upload" id="upload_file">
                    开始上传
                </button>
            </div>

            <div id="totalBar" style="float:left;width:80%;height:30px;border:1px solid;border-radius:3px;display:none;">
                <div id="totalBarColor"
                     style="width:0;border:0;background-color:rgba(232,152,39,0.8);height:28px;"></div>
                <p class="speed"></p>
            </div>
        </div>
    </div>
{% endblock content %}

{% block scripts %}
    <script type="text/javascript" src="https://unpkg.com/qiniu-js@2.5.4/dist/qiniu.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var vids = document.getElementsByTagName('video');
            var vid1 = vids[0];
            var vid2 = vids[1];
            vid1.onended = function (ev) {
                console.log('完毕');
                alert('播放完毕');
            };
            vid2.onended = function (ev) {
                console.log('完毕');
                alert('播放完毕');
            };

            $('#choose_file').on("change", function () {
                var file = this.files[0];
                var key = file.name;
                $.ajax({
                    url: "/course/uptoken?key=" + key, success: function (res) {
                        var token = res.uptoken;
                        var domain = res.domain;
                        var config = {
                            useCdnDomain: true,
                            disableStatisticsReport: false,
                            retryCount: 6,
                        };
                        var putExtra = {
                            fname: "",
                            params: {},
                            mimeType: null
                        };


                        var compareChunks = [];
                        var finishedAttr = [];
                        var qiniu_domain = 'http://qiniu.chajiatongmen.com/';
                        var dom_total = $("#totalBar").children("#totalBarColor");
                        // 设置next,error,complete对应的操作，分别处理相应的进度信息，错误信息，以及完成后的操作
                        var error = function (err) {
                            $("#upload_file").text("继续上传");
                            console.log(err);
                            alert("上传出错")
                        };

                        var complete = function (res) {
                            $("#totalBar").addClass("hide");
                            $("#control-container")
                                .html(
                                    "上传完毕，视频地址为：" + qiniu_domain + res.key
                                );
                        };

                        var next = function (response) {
                            var chunks = response.chunks || [];
                            var total = response.total;
                            // 这里对每个chunk更新进度，并记录已经更新好的避免重复更新，同时对未开始更新的跳过
                            for (var i = 0; i < chunks.length; i++) {
                                if (chunks[i].percent === 0 || finishedAttr[i]) {
                                    continue;
                                }
                                if (compareChunks[i].percent === chunks[i].percent) {
                                    continue;
                                }
                                if (chunks[i].percent === 100) {
                                    finishedAttr[i] = true;
                                }
                            }
                            $(".speed")
                                .text("进度：" + total.percent + "% ");
                            dom_total.css(
                                "width",
                                total.percent + "%"
                            );
                            compareChunks = chunks;
                        };

                        var observable = qiniu.upload(file, key, token, putExtra, config);
                        var subscription;
                        var sub_object = {
                            next: next,
                            error: error,
                            complete: complete
                        };
                        $("#upload_file").click(function (e) {
                            $('#control-container').html("");
                            $('#totalBar').show();
                            subscription = observable.subscribe(sub_object);
                        });
                    }
                });
            });

        });
    </script>

{% endblock scripts %}